---
phase: 05-email-notifications
plan: 01
type: execute
depends_on:
  - phase: 04-file-upload-system
    plan: 04
files_modified: []
---

<objective>
Set up email notification infrastructure and appointment reminder tracking fields.

Purpose: Provide reusable email templates and track reminder delivery to prevent duplicates.

Output: Email template helpers, appointment reminder fields in Prisma, and migration applied.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/email.ts
@prisma/schema.prisma

**Tech decisions:**
- DEC-002: Resend for email delivery

**Current state:**
- sendEmail utility exists
- No appointment-specific templates
- Appointment model has no reminder tracking fields

**Requirements:**
- Human-readable templates for confirmations/reminders/cancellations
- Reminder tracking (24h + 1h) to avoid duplicates
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create appointment email templates helper</name>
  <files>src/lib/appointment-emails.ts (new)</files>
  <action>
Create template helpers returning `{ subject, html, text }` for:
- Appointment confirmation
- Appointment reminder (24h/1h)
- Appointment cancellation
- Appointment reschedule

Include appointment date/time, type, and psychologist/patient names.
  </action>
  <verify>
Template functions export with consistent API and no syntax errors.
  </verify>
  <done>
- Reusable email template helpers added
  </done>
</task>

<task type="auto">
  <name>Task 2: Add reminder tracking fields to Appointment model</name>
  <files>prisma/schema.prisma</files>
  <action>
Add:
- `reminder24hSentAt DateTime?`
- `reminder1hSentAt DateTime?`

Use these to prevent duplicate reminders.
  </action>
  <verify>
```bash
rg -n "reminder24hSentAt|reminder1hSentAt" prisma/schema.prisma
```
  </verify>
  <done>
- Appointment model includes reminder tracking fields
  </done>
</task>

<task type="auto">
  <name>Task 3: Run Prisma migration</name>
  <files>prisma/migrations/*</files>
  <action>
Run Prisma migration to apply reminder tracking fields.

```bash
npx prisma migrate dev --name add-appointment-reminders
```
  </action>
  <verify>
Migration created and applied; Prisma client generated.
  </verify>
  <done>
- Database updated with reminder fields
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Appointment email templates exist
- [ ] Appointment reminder fields added
- [ ] Migration applied successfully
</verification>

<success_criteria>
- Email templates ready for notification flows
- Reminder tracking present in database
</success_criteria>

<output>
After completion, create `.planning/phases/05-email-notifications/05-01-SUMMARY.md`
</output>
