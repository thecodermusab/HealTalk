---
phase: 04-file-upload-system
plan: 04
type: execute
depends_on:
  - phase: 04-file-upload-system
    plan: 02
  - phase: 04-file-upload-system
    plan: 03
files_modified: []
---

<objective>
Harden file upload validation and access controls, and document Phase 4 completion.

Purpose: Ensure files are safe, properly validated, and only accessible to authorized users.

Output: Validation enforced, secure access routes in place, and planning docs updated.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/app/api/uploadthing/core.ts
@src/app/api/uploadthing/route.ts

**Requirements:**
- Size + type validation
- Auth checks (role-based)
- Secure access to credential docs
- Update project state + roadmap
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add signed URL access for credential documents</name>
  <files>src/app/api/uploads/credential/route.ts (new)</files>
  <action>
Create a secure API route that:
- Validates user session
- Ensures user is a psychologist or admin
- Reads credentialDocumentKey from DB
- Returns a signed URL (short-lived) for document access

Use Uploadthing server utilities (UTApi) to generate signed URLs.
  </action>
  <verify>
- GET /api/uploads/credential returns a signed URL for authorized users
- Unauthorized users get 401/403
  </verify>
  <done>
- Secure access route in place
  </done>
</task>

<task type="auto">
  <name>Task 2: Harden validation + error feedback</name>
  <files>
src/app/api/uploadthing/core.ts
src/components/profile/AvatarUploader.tsx
src/app/(dashboard)/psychologist/dashboard/profile/page.tsx
  </files>
  <action>
Ensure:
- Size + type limits enforced per endpoint
- Clear error messages surfaced in UI when upload fails
- Role enforcement for credential uploads
  </action>
  <verify>
- Invalid file types rejected with user-visible error
- Non-psychologists cannot use credential upload
  </verify>
  <done>
- Validation and UI feedback complete
  </done>
</task>

<task type="auto">
  <name>Task 3: Update planning state + summaries</name>
  <files>
.planning/phases/04-file-upload-system/04-04-SUMMARY.md
.planning/STATE.md
.planning/ROADMAP.md
  </files>
  <action>
- Write Phase 4 summary file
- Mark Phase 4 complete in ROADMAP
- Update STATE metrics and current focus
  </action>
  <verify>
- ROADMAP shows Phase 4 checked
- STATE shows Phase 4 complete
  </verify>
  <done>
- Project planning docs updated
  </done>
</task>

<task type="auto">
  <name>Task 4: Commit changes</name>
  <files>All modified</files>
  <action>
Commit with a detailed message summarizing Phase 4 work.
  </action>
  <verify>
```bash
git log -1 --oneline
```
  </verify>
  <done>
- Commit created for Phase 4
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Signed URL route works for credential docs
- [ ] Validation rules enforced
- [ ] UI surfaces upload errors
- [ ] ROADMAP/STATE updated
- [ ] Commit created
</verification>

<success_criteria>
- File uploads are secure and validated
- Credential docs are access-controlled
- Phase 4 fully documented and committed
</success_criteria>

<output>
After completion, create `.planning/phases/04-file-upload-system/04-04-SUMMARY.md`
</output>
