---
phase: 04-file-upload-system
plan: 01
type: execute
depends_on:
  - phase: 03-data-migration
    plan: 04
files_modified: []
---

<objective>
Set up Uploadthing for the App Router with secure, authenticated upload endpoints and data storage fields for user avatars and credential documents.

Purpose: Establish the backend foundation for file uploads with proper auth gates, storage references, and typed client helpers.

Output: Uploadthing router + API route handlers, Prisma schema updated for upload metadata, and shared client upload helpers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@src/lib/auth.ts

**Tech decisions:**
- DEC-003: Use Uploadthing (free tier, 2GB)
- NextAuth v4 with JWT sessions

**Current state:**
- No Uploadthing code present
- User model already has `image` field for avatar URL
- Psychologist model has no document URL field yet

**Requirements:**
- Authenticated uploads only
- Profile images (images only, max size)
- Credential documents (PDF + images, max size)
- Secure access control and validation
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Uploadthing packages</name>
  <files>package.json, package-lock.json</files>
  <action>
Install Uploadthing for App Router and React helpers.

```bash
npm install uploadthing @uploadthing/react
```
  </action>
  <verify>
```bash
node -e "const pkg=require('./package.json'); console.log(pkg.dependencies['uploadthing'] && pkg.dependencies['@uploadthing/react'])"
```
  </verify>
  <done>
- uploadthing + @uploadthing/react added to dependencies
- lockfile updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Prisma fields for credential documents</name>
  <files>prisma/schema.prisma</files>
  <action>
Add fields to Psychologist model for credential document storage.

Suggested fields:
- `credentialDocumentUrl String?`
- `credentialDocumentKey String?`

This allows signed access and safe replacement/deletion.
  </action>
  <verify>
```bash
rg -n "credentialDocument" prisma/schema.prisma
```
  </verify>
  <done>
- Psychologist model includes credential document URL + key
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Uploadthing router + handlers</name>
  <files>
src/app/api/uploadthing/core.ts
src/app/api/uploadthing/route.ts
src/lib/uploadthing.ts
  </files>
  <action>
Create App Router upload endpoints with auth middleware:

- `avatar` endpoint: image only, max 2MB, 1 file
- `credentialDocument` endpoint: PDF + image, max 10MB, 1 file, PSYCHOLOGIST only

On upload complete:
- `avatar`: update `User.image`
- `credentialDocument`: update `Psychologist.credentialDocumentUrl` + `credentialDocumentKey`

Also create shared Uploadthing React helpers in `src/lib/uploadthing.ts`.
  </action>
  <verify>
- API routes exist: `/api/uploadthing`
- Router exports `OurFileRouter`
- Upload helpers compile with correct types
  </verify>
  <done>
- Uploadthing server + client helpers ready
- Auth middleware enforced per endpoint
  </done>
</task>

<task type="auto">
  <name>Task 4: Add upload file host to Next image config (if needed)</name>
  <files>next.config.ts</files>
  <action>
Allow Uploadthing-hosted images in Next config (ufs/utfs domain patterns). Add remotePatterns for:
- `*.ufs.sh`
- `*.utfs.io`

Keep existing config intact.
  </action>
  <verify>
- next.config.ts includes Uploadthing remotePatterns
  </verify>
  <done>
- Uploadthing-hosted images display safely
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Uploadthing deps installed
- [ ] Prisma schema includes credential document fields
- [ ] Uploadthing router + route handler in place
- [ ] Uploadthing React helpers exported
- [ ] Next config allows Uploadthing image domains
</verification>

<success_criteria>
- Uploadthing backend is wired and auth-protected
- Schema supports credential document storage
- Client helpers available for UI integration
</success_criteria>

<output>
After completion, create `.planning/phases/04-file-upload-system/04-01-SUMMARY.md`
</output>
