---
phase: 01-foundation-environment
plan: 03
type: execute
depends_on: ["01-01", "01-02"]
files_modified: [.env, .env.example]
---

<objective>
Configure all environment variables in .env file with credentials from database and service accounts, and update .env.example with proper placeholders.

Purpose: Centralize all configuration in environment variables following Next.js and security best practices. Ensures credentials are never committed to git while providing clear documentation for deployment.

Output: Working .env file with all credentials configured, updated .env.example template.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-environment/01-01-SUMMARY.md
@.planning/phases/01-foundation-environment/01-02-SUMMARY.md
@.env.example

**Prerequisites from previous plans:**
- 01-01: PostgreSQL connection string from [provider]
- 01-02: 10 API keys/credentials from 6 services

**Current .env.example structure:**
- Has placeholders for: DATABASE_URL, NEXTAUTH_*, GOOGLE_*, FACEBOOK_*, EMAIL_*, AGORA_*, STRIPE_*
- Missing: RESEND_*, UPLOADTHING_*, SENTRY_*

**Security requirements:**
- .env must be in .gitignore (already is)
- Never commit real credentials
- Use strong NEXTAUTH_SECRET
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate secure NEXTAUTH_SECRET and create .env file</name>
  <files>.env</files>
  <action>
1. Generate a secure secret for NextAuth JWT signing:
   ```bash
   openssl rand -base64 32
   ```
   This produces a cryptographically secure 32-byte secret.

2. Create .env file with all credentials from previous plans:

```env
# Database (from Plan 01-01)
DATABASE_URL="[connection-string-from-neon/supabase/railway]"

# NextAuth Configuration
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="[generated-secret-from-openssl]"

# OAuth Providers (from Plan 01-02)
GOOGLE_CLIENT_ID="[your-client-id].apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="GOCSPX-[your-secret]"

# Email Service (Resend - from Plan 01-02)
RESEND_API_KEY="re_[your-key]"
EMAIL_FROM="noreply@healtalk.com"

# Video Calls (Agora - from Plan 01-02)
AGORA_APP_ID="[your-32-char-app-id]"
AGORA_APP_CERTIFICATE="[your-32-char-certificate]"

# File Uploads (Uploadthing - from Plan 01-02)
UPLOADTHING_SECRET="sk_live_[your-secret]"
UPLOADTHING_APP_ID="[your-app-id]"

# Payment Processing (Stripe - from Plan 01-02)
STRIPE_PUBLIC_KEY="pk_test_[your-key]"
STRIPE_SECRET_KEY="sk_test_[your-key]"
STRIPE_WEBHOOK_SECRET="whsec_[to-be-added-later]"

# Error Tracking (Sentry - from Plan 01-02)
SENTRY_DSN="https://[your-key]@sentry.io/[project-id]"

# App Configuration
NEXT_PUBLIC_APP_URL="http://localhost:3000"
```

3. Replace ALL placeholder values with actual credentials from Plans 01-01 and 01-02
4. Ensure .env is listed in .gitignore (verify with `cat .gitignore | grep .env`)

**Important:**
- STRIPE_WEBHOOK_SECRET is empty for now (will be set in Phase 8 when configuring webhooks)
- NEXT_PUBLIC_* variables are exposed to client-side code (only add non-sensitive values)
- Double-check DATABASE_URL includes `?sslmode=require` for Neon/Supabase
  </action>
  <verify>
Verify .env file:
```bash
# Check file exists and has correct permissions
ls -la .env

# Verify all required variables are set (should show values, not placeholders)
cat .env | grep -E "(DATABASE_URL|NEXTAUTH_SECRET|GOOGLE_CLIENT_ID|RESEND_API_KEY|AGORA_APP_ID|UPLOADTHING_SECRET|STRIPE_SECRET_KEY|SENTRY_DSN)" | wc -l
# Should output: 8 (one line per key variable)

# Verify .env is in .gitignore
git check-ignore .env
# Should output: .env (confirms it's ignored)

# Check NEXTAUTH_SECRET length (should be 44 chars for base64-encoded 32 bytes)
cat .env | grep NEXTAUTH_SECRET | cut -d'"' -f2 | wc -c
# Should be around 44-45
```
  </verify>
  <done>
- .env file created with all credentials
- NEXTAUTH_SECRET generated and added
- All placeholders replaced with real values
- .env confirmed in .gitignore
- File permissions secure (readable by user only)
  </done>
</task>

<task type="auto">
  <name>Task 2: Update .env.example with new services</name>
  <files>.env.example</files>
  <action>
Update .env.example to include Resend, Uploadthing, and Sentry (currently missing), and add helpful comments:

```env
# Environment variables for HealTalk
# Copy this file to .env and fill in actual values
# NEVER commit .env to git!

# ======================
# Database
# ======================
DATABASE_URL="postgresql://user:password@host:5432/psyconnect?sslmode=require"
# Get from: Neon, Supabase, or Railway (see Phase 1 Plan 01-01)

# ======================
# Authentication
# ======================
NEXTAUTH_URL="http://localhost:3000"
# For production: https://yourdomain.com

NEXTAUTH_SECRET="generate-with-openssl-rand-base64-32"
# Generate: openssl rand -base64 32

# ======================
# OAuth Providers
# ======================
# Google OAuth (required)
GOOGLE_CLIENT_ID="your-client-id.apps.googleusercontent.com"
GOOGLE_CLIENT_SECRET="GOCSPX-your-secret"
# Get from: Google Cloud Console > APIs & Services > Credentials

# Facebook OAuth (optional - not used in MVP)
# FACEBOOK_CLIENT_ID="your-facebook-app-id"
# FACEBOOK_CLIENT_SECRET="your-facebook-secret"

# ======================
# Email Service (Resend)
# ======================
RESEND_API_KEY="re_your_api_key"
# Get from: resend.com/api-keys
# Free tier: 3,000 emails/month

EMAIL_FROM="noreply@yourdomain.com"
# Verify your domain in Resend dashboard for production

# ======================
# Video Calls (Agora.io)
# ======================
AGORA_APP_ID="your-32-character-app-id"
AGORA_APP_CERTIFICATE="your-32-character-certificate"
# Get from: console.agora.io
# Free tier: 10,000 minutes/month

# ======================
# File Uploads (Uploadthing)
# ======================
UPLOADTHING_SECRET="sk_live_your_secret"
UPLOADTHING_APP_ID="your-app-id"
# Get from: uploadthing.com/dashboard
# Free tier: 2GB storage

# ======================
# Payment Processing (Stripe)
# ======================
STRIPE_PUBLIC_KEY="pk_test_your_key"
STRIPE_SECRET_KEY="sk_test_your_key"
STRIPE_WEBHOOK_SECRET="whsec_your_webhook_secret"
# Get from: dashboard.stripe.com/apikeys
# Webhook secret from Stripe CLI or dashboard webhooks

# ======================
# Error Tracking (Sentry)
# ======================
SENTRY_DSN="https://your-key@sentry.io/your-project-id"
# Get from: sentry.io > Settings > Projects > healtalk-production
# Free tier: 5,000 errors/month

# ======================
# App Configuration
# ======================
NEXT_PUBLIC_APP_URL="http://localhost:3000"
# For production: https://yourdomain.com
```

**What changed:**
- Added Resend section (replacing generic EMAIL_SERVER)
- Added Uploadthing section (new)
- Added Sentry section (new)
- Removed Facebook OAuth (marked optional)
- Added helpful comments for each section
- Added generation/source instructions
- Added free tier limits
  </action>
  <verify>
```bash
# Verify .env.example has all new sections
cat .env.example | grep -E "(RESEND_API_KEY|UPLOADTHING_SECRET|SENTRY_DSN)" | wc -l
# Should output: 3

# Verify it has NO real credentials (all should be placeholders)
cat .env.example | grep -E "re_[A-Za-z0-9]{20,}|sk_live_|https://.*@sentry\.io" | wc -l
# Should output: 0 (no real values)

# Verify file is tracked by git (should be in repo)
git ls-files .env.example
# Should output: .env.example
```
  </verify>
  <done>
- .env.example updated with new services
- All sections documented with helpful comments
- Placeholders provided for all variables
- File ready for git commit
- No real credentials in example file
  </done>
</task>

<task type="auto">
  <name>Task 3: Test environment variable loading</name>
  <files>None (verification only)</files>
  <action>
Create a simple test script to verify all environment variables load correctly:

1. Create temporary test file:
```javascript
// test-env.js
require('dotenv').config();

const required = [
  'DATABASE_URL',
  'NEXTAUTH_URL',
  'NEXTAUTH_SECRET',
  'GOOGLE_CLIENT_ID',
  'GOOGLE_CLIENT_SECRET',
  'RESEND_API_KEY',
  'AGORA_APP_ID',
  'AGORA_APP_CERTIFICATE',
  'UPLOADTHING_SECRET',
  'UPLOADTHING_APP_ID',
  'STRIPE_PUBLIC_KEY',
  'STRIPE_SECRET_KEY',
  'SENTRY_DSN'
];

console.log('Checking environment variables...\n');

let missing = [];
let present = [];

required.forEach(key => {
  const value = process.env[key];
  if (!value || value.includes('your-') || value.includes('generate-')) {
    missing.push(key);
    console.log(`❌ ${key}: MISSING or PLACEHOLDER`);
  } else {
    present.push(key);
    console.log(`✓ ${key}: Set (${value.substring(0, 20)}...)`);
  }
});

console.log(`\n${present.length}/${required.length} variables configured`);

if (missing.length > 0) {
  console.log('\nMissing variables:', missing.join(', '));
  process.exit(1);
}

console.log('\n✓ All environment variables configured correctly!');
```

2. Run test:
```bash
node test-env.js
```

3. If successful (all variables set), delete test file:
```bash
rm test-env.js
```

**Expected output:**
- 13 checkmarks showing all variables are set
- No missing variables
- Exit code 0

**If test fails:**
- Review which variables are missing/placeholder
- Check .env file for typos or missing values
- Re-run after fixing
  </action>
  <verify>
Test script output shows:
- All 13 required variables present
- No placeholders detected (no "your-" or "generate-" in values)
- Database URL starts with `postgresql://`
- All API keys follow expected formats
- Test script exits with code 0
- test-env.js file deleted after successful run
  </verify>
  <done>
- Environment variable test script created and run
- All 13 required variables validated
- No placeholders remaining in .env
- Test file cleaned up
- Environment configuration verified working
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] .env file exists with all credentials
- [ ] NEXTAUTH_SECRET is cryptographically secure (32-byte base64)
- [ ] .env is in .gitignore
- [ ] .env.example updated with new services
- [ ] .env.example has NO real credentials
- [ ] All 13 environment variables load correctly
- [ ] No placeholders in .env
</verification>

<success_criteria>

- .env file created with all credentials from Plans 01-01 and 01-02
- NEXTAUTH_SECRET generated with openssl
- .env confirmed in .gitignore (never committed)
- .env.example updated with Resend, Uploadthing, Sentry
- .env.example has helpful comments and placeholders
- Environment variable loading tested and verified
- All 13 required variables present and valid
- Ready for database migration in Plan 01-04
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-environment/01-03-SUMMARY.md`:

# Phase 1 Plan 3: Environment Configuration Summary

**All environment variables configured with production credentials and verified working**

## Accomplishments

- Generated secure NEXTAUTH_SECRET (cryptographic strength)
- Created .env with 13 environment variables
- Updated .env.example with new services (Resend, Uploadthing, Sentry)
- Verified all credentials load correctly
- Confirmed .env in .gitignore

## Files Created/Modified

- `.env` - Production environment variables (created, not committed)
- `.env.example` - Updated template with all services

## Environment Variables Configured

| Category | Variables | Source |
|----------|-----------|--------|
| Database | DATABASE_URL | Plan 01-01 |
| Auth | NEXTAUTH_URL, NEXTAUTH_SECRET | Generated |
| OAuth | GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET | Plan 01-02 |
| Email | RESEND_API_KEY, EMAIL_FROM | Plan 01-02 |
| Video | AGORA_APP_ID, AGORA_APP_CERTIFICATE | Plan 01-02 |
| Files | UPLOADTHING_SECRET, UPLOADTHING_APP_ID | Plan 01-02 |
| Payments | STRIPE_PUBLIC_KEY, STRIPE_SECRET_KEY | Plan 01-02 |
| Errors | SENTRY_DSN | Plan 01-02 |

**Total:** 13 variables + 3 placeholders (STRIPE_WEBHOOK_SECRET, NEXT_PUBLIC_APP_URL, EMAIL_FROM domain)

## Decisions Made

- Using base64 encoding for NEXTAUTH_SECRET (standard for NextAuth)
- EMAIL_FROM set to "noreply@healtalk.com" (domain verification needed for production)
- STRIPE_WEBHOOK_SECRET deferred to Phase 8 (payment integration)

## Security Verification

- .env confirmed in .gitignore
- No credentials committed to repository
- .env.example contains only placeholders
- All secrets validated as non-placeholder values

## Issues Encountered

[Any configuration issues or none]

## Next Step

Ready for 01-04-PLAN.md - Database migration and verification
</output>
