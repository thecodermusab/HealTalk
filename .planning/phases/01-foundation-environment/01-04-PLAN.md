---
phase: 01-foundation-environment
plan: 04
type: execute
depends_on: ["01-03"]
files_modified: [prisma/migrations/*, .gitignore]
---

<objective>
Run Prisma database migrations to create all tables in production database, seed with initial data, and verify the complete database setup is working.

Purpose: Transform the empty PostgreSQL database into a fully structured database with all 15 models (User, Patient, Psychologist, Admin, Appointment, Message, Favorite, Review, Payment, Progress, Hospital, Availability, Account, Session, VerificationToken). Seed with bootstrap data for testing.

Output: Production database with complete schema, seeded data, and verified Prisma client generation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-environment/01-03-SUMMARY.md
@prisma/schema.prisma
@prisma/seed.ts
@.env

**Prerequisites:**
- DATABASE_URL configured in .env (from Plan 01-03)
- PostgreSQL database running (from Plan 01-01)
- Prisma schema with 15 models already defined

**Current migration status:**
- Existing migration: `20260126105840_init` (creates all 15 tables)
- Migration may need to be re-run or recreated for production database

**Database models (15 total):**
User, Account, Session, VerificationToken, Patient, Psychologist, Admin, Appointment, Message, Favorite, Review, Payment, Progress, Hospital, Availability

**Seed data (from seed.ts):**
- 2 hospitals (Acıbadem, Memorial)
- 3 bootstrap users (psychologist, patient, admin)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Prisma Client and run database migration</name>
  <files>prisma/migrations/*, node_modules/.prisma/client/*</files>
  <action>
1. First, generate Prisma Client types (creates TypeScript types from schema):
```bash
npm run db:generate
```

This runs `prisma generate` which:
- Reads prisma/schema.prisma
- Generates TypeScript client in node_modules/@prisma/client
- Creates types for all 15 models
- Enables type-safe database queries

Expected output: "Generated Prisma Client" with list of models

2. Run database migration to production database:
```bash
npm run db:migrate
```

This runs `prisma migrate dev` which:
- Connects to DATABASE_URL from .env
- Detects changes between schema and database
- Since production DB is empty, it will apply the existing migration
- Creates all 15 tables with relationships
- Updates migration history in `_prisma_migrations` table

**IMPORTANT:**
- If asked "We need to reset the database, do you want to continue? (y/N)", type 'y'
- If migration already exists, it will detect and apply it
- If schema changed, it may prompt for migration name

Expected output: "Your database is now in sync with your schema"

3. Verify migration success:
```bash
npx prisma db execute --stdin <<< "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' ORDER BY table_name;" --url="${DATABASE_URL}"
```

Should show 16 tables (15 models + _prisma_migrations)

**Error handling:**
- If connection fails: Check DATABASE_URL in .env
- If SSL error: Ensure `?sslmode=require` in connection string
- If permission error: Verify database user has CREATE TABLE privilege
  </action>
  <verify>
Verify Prisma Client generation and migration:

```bash
# 1. Check Prisma Client was generated
ls -la node_modules/@prisma/client/
# Should show index.d.ts and other generated files

# 2. Verify migration ran
ls -la prisma/migrations/
# Should show at least one migration directory

# 3. Count tables in database
npx prisma db execute --stdin <<< "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';" --url="${DATABASE_URL}"
# Should return: 16 (15 models + 1 migration table)

# 4. Test Prisma connection with simple query
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.\$connect().then(() => console.log('✓ Connected')).catch(e => console.error('✗ Error:', e.message)).finally(() => prisma.\$disconnect());"
# Should output: ✓ Connected
```
  </verify>
  <done>
- Prisma Client generated successfully
- Database migration completed
- All 15 tables created in production database
- Migration history recorded
- Prisma can connect to database
  </done>
</task>

<task type="auto">
  <name>Task 2: Seed database with bootstrap data</name>
  <files>None (database only)</files>
  <action>
Seed the database with initial data for testing:

1. Review seed script to understand what will be created:
```bash
cat prisma/seed.ts | head -50
```

The seed creates:
- 2 hospitals (Acıbadem Maslak, Memorial Şişli)
- 3 users with roles:
  - Psychologist: ahmet@example.com / password123
  - Patient: john@example.com / password123
  - Admin: admin@example.com / password123

2. Run seed script:
```bash
npm run db:seed
```

This runs `tsx prisma/seed.ts` which:
- Hashes all passwords with bcryptjs (12 rounds)
- Creates User records
- Creates associated Patient/Psychologist/Admin records
- Creates Hospital records
- Links psychologist to hospital

Expected output: "Database seeded successfully!" with count of created records

3. Verify seed data:
```bash
# Count users
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.user.count().then(c => console.log('Users:', c)).finally(() => prisma.\$disconnect());"
# Should show: Users: 3

# Count hospitals
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.hospital.count().then(c => console.log('Hospitals:', c)).finally(() => prisma.\$disconnect());"
# Should show: Hospitals: 2
```

**Note:** Seed script is idempotent - it checks if data exists before creating. Safe to run multiple times.

**Bootstrap credentials (for testing in Phase 2):**
- Psychologist: `ahmet@example.com` / `password123`
- Patient: `john@example.com` / `password123`
- Admin: `admin@example.com` / `password123`
  </action>
  <verify>
Verify seed data was created:

```bash
# 1. Check all users were created with correct roles
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.user.findMany({ select: { email: true, role: true } }).then(users => { console.log('Bootstrap Users:'); users.forEach(u => console.log(\`  - \${u.email} (\${u.role})\`)); }).finally(() => prisma.\$disconnect());"

# Expected output:
#   - ahmet@example.com (PSYCHOLOGIST)
#   - john@example.com (PATIENT)
#   - admin@example.com (ADMIN)

# 2. Verify psychologist has associated Psychologist record
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.psychologist.count().then(c => console.log('Psychologist profiles:', c)).finally(() => prisma.\$disconnect());"
# Should show: Psychologist profiles: 1

# 3. Verify patient has associated Patient record
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.patient.count().then(c => console.log('Patient profiles:', c)).finally(() => prisma.\$disconnect());"
# Should show: Patient profiles: 1

# 4. Verify admin has associated Admin record
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.admin.count().then(c => console.log('Admin profiles:', c)).finally(() => prisma.\$disconnect());"
# Should show: Admin profiles: 1

# 5. Check hospitals
node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.hospital.findMany({ select: { name: true, location: true } }).then(h => { console.log('Hospitals:'); h.forEach(hospital => console.log(\`  - \${hospital.name} (\${hospital.location})\`)); }).finally(() => prisma.\$disconnect());"
# Should show: 2 hospitals
```
  </verify>
  <done>
- Seed script executed successfully
- 3 users created (psychologist, patient, admin)
- All users have associated role-specific records
- 2 hospitals created
- Passwords hashed with bcrypt
- Bootstrap credentials available for testing
  </done>
</task>

<task type="auto">
  <name>Task 3: Open Prisma Studio and verify database visually</name>
  <files>None (GUI tool)</files>
  <action>
Launch Prisma Studio to visually inspect the database:

1. Start Prisma Studio:
```bash
npm run db:studio
```

This will:
- Start local server on http://localhost:5555
- Open browser automatically
- Show GUI for all database tables

2. In Prisma Studio, verify:
- **Left sidebar:** Shows all 15 models + tables
- **User table:** Click "User" - should see 3 rows (ahmet, john, admin)
- **Patient table:** Should show 1 row (john's patient profile)
- **Psychologist table:** Should show 1 row (ahmet's psychologist profile)
- **Admin table:** Should show 1 row (admin's admin profile)
- **Hospital table:** Should show 2 rows (Acıbadem, Memorial)
- **Other tables:** Should be empty (Appointment, Message, etc.) - normal for fresh database

3. Test data editing:
- Click on User table
- Click on any user row
- Verify you can see all fields (id, email, role, password hash, etc.)
- Do NOT edit anything - just verify visibility

4. Close Prisma Studio:
- Press Ctrl+C in terminal to stop the server
  </action>
  <verify>
Prisma Studio verification checklist:
- [ ] Studio opened at http://localhost:5555
- [ ] All 15 models visible in sidebar
- [ ] User table shows 3 users with correct roles
- [ ] Patient table shows 1 record (linked to john@example.com)
- [ ] Psychologist table shows 1 record (linked to ahmet@example.com)
- [ ] Admin table shows 1 record (linked to admin@example.com)
- [ ] Hospital table shows 2 hospitals
- [ ] Password fields show bcrypt hashes (starting with $2b$)
- [ ] All IDs are cuid format (e.g., "clxxx...")
- [ ] Timestamps (createdAt, updatedAt) are present
- [ ] Studio closed cleanly (Ctrl+C)
  </verify>
  <done>
- Prisma Studio launched successfully
- All database tables verified visually
- Seed data confirmed present and correct
- Relationships between tables verified
- Studio closed without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production database with complete schema and bootstrap data</what-built>
  <how-to-verify>
**Final verification checklist:**

1. **Database connection:**
   ```bash
   node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.\$connect().then(() => console.log('✓ DB Connected')).catch(e => console.error('✗ Error:', e)).finally(() => prisma.\$disconnect());"
   ```
   Expected: `✓ DB Connected`

2. **Table count:**
   ```bash
   npx prisma db execute --stdin <<< "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';" --url="${DATABASE_URL}"
   ```
   Expected: 16 tables

3. **Test query (all users):**
   ```bash
   node -e "const { PrismaClient } = require('@prisma/client'); const prisma = new PrismaClient(); prisma.user.findMany().then(u => console.log('Users:', u.length)).finally(() => prisma.\$disconnect());"
   ```
   Expected: `Users: 3`

4. **Test authentication (NextAuth dependency):**
   Try logging in with bootstrap credentials in Phase 2

5. **Provider dashboard:**
   - Check your database provider dashboard (Neon/Supabase/Railway)
   - Verify database shows activity/queries
   - Confirm storage usage (should be < 1MB with just seed data)

**Sign-off:**
- [ ] All 16 tables exist
- [ ] Bootstrap users can be queried
- [ ] Prisma Client connects successfully
- [ ] No migration errors
- [ ] Ready for authentication implementation (Phase 2)
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any failures</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Prisma Client generated successfully
- [ ] Database migration completed (all 15 tables + migration table)
- [ ] Seed script executed without errors
- [ ] Bootstrap data verified (3 users, 2 hospitals)
- [ ] Prisma Studio shows correct data
- [ ] Database connection tested successfully
- [ ] All verifications passed
</verification>

<success_criteria>

- Prisma Client generated with types for all 15 models
- Database migration created all tables in production database
- Migration history recorded in _prisma_migrations table
- Seed data created successfully (3 users, 2 hospitals)
- User roles correctly assigned (PATIENT, PSYCHOLOGIST, ADMIN)
- Associated profiles created (Patient, Psychologist, Admin records)
- Passwords hashed with bcrypt
- Prisma Studio shows all data correctly
- Database connection verified working
- Phase 1 complete - ready for Phase 2 (Authentication)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-environment/01-04-SUMMARY.md`:

# Phase 1 Plan 4: Database Migration & Verification Summary

**Production database migrated with complete schema (16 tables) and verified with bootstrap data**

## Accomplishments

- Generated Prisma Client with TypeScript types for all 15 models
- Ran database migration to production PostgreSQL
- Created all 16 tables (15 models + migration history)
- Seeded database with bootstrap users and hospitals
- Verified database with Prisma Studio
- Confirmed all queries working

## Files Created/Modified

- `prisma/migrations/` - Migration files applied to production
- `node_modules/@prisma/client/` - Generated Prisma Client
- Database: 16 tables created with seed data

## Database Schema

**15 Models Migrated:**
- **Auth:** User, Account, Session, VerificationToken
- **Roles:** Patient, Psychologist, Admin
- **Core Features:** Appointment, Message, Favorite, Review
- **Business:** Payment, Progress, Hospital, Availability

**Total tables:** 16 (including _prisma_migrations)

## Bootstrap Data

**Users (3):**
- ahmet@example.com (PSYCHOLOGIST) - password: password123
- john@example.com (PATIENT) - password: password123
- admin@example.com (ADMIN) - password: password123

**Hospitals (2):**
- Acıbadem Maslak (İstanbul, Turkey)
- Memorial Şişli (İstanbul, Turkey)

**Note:** All passwords hashed with bcryptjs (12 rounds)

## Decisions Made

- Used existing migration `20260126105840_init` (no schema changes needed)
- Seed script creates idempotent data (safe to re-run)
- Bootstrap credentials for testing in development only

## Issues Encountered

[Any migration/seeding issues or none]

## Phase 1 Complete

**Infrastructure ready:**
- ✅ PostgreSQL database (Neon/Supabase/Railway)
- ✅ All service accounts created (Agora, Resend, Uploadthing, Stripe, Sentry, Google OAuth)
- ✅ Environment variables configured
- ✅ Database schema migrated
- ✅ Bootstrap data seeded
- ✅ Prisma Client generated

## Next Phase

**Phase 2: Authentication System** - Implement Google OAuth, email verification, and password reset using NextAuth.js with the bootstrap users for testing.

`/gsd:plan-phase 2`
</output>
