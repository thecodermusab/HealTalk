---
phase: 03-data-migration
plan: 02
type: execute
depends_on: ["03-01"]
files_modified: [src/app/api/psychologists/route.ts, src/app/api/psychologists/[id]/route.ts, src/app/find-psychologists/page.tsx, src/app/psychologists/[id]/page.tsx]
---

<objective>
Update psychologist listing and profile pages to fetch data from PostgreSQL database via API routes instead of importing from mock-data.ts.

Purpose: Connect frontend components to real database, enabling dynamic data that can be searched, filtered, and updated without code deployments.

Output: Working psychologist directory and profile pages powered by database queries through Next.js API routes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-data-migration/03-01-SUMMARY.md
@prisma/schema.prisma
@src/app/find-psychologists/page.tsx
@src/app/psychologists/[id]/page.tsx
@src/lib/mock-data.ts

**Prerequisites:**
- Database populated with 20+ psychologists (from Plan 03-01)
- Psychologist model includes: user (name, image), credentials, experience, bio, specializations, price60, price90, rating, reviewCount, status, hospital
- Prisma Client generated and available

**Current implementation:**
- find-psychologists/page.tsx imports from mock-data.ts
- psychologists/[id]/page.tsx imports from mock-data.ts
- Client-side filtering and search
- No API layer

**Target implementation:**
- API routes query database with filters
- Server-side filtering, pagination
- Client fetches from API
- Dynamic data instead of static imports
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create psychologists listing API route</name>
  <files>src/app/api/psychologists/route.ts</files>
  <action>
Create `src/app/api/psychologists/route.ts` with GET endpoint that queries psychologists from database with filtering.

```typescript
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET(request: Request) {
  try {
    const { searchParams } = new URL(request.url);
    const search = searchParams.get('search') || '';
    const specialization = searchParams.get('specialization') || '';
    const minRating = parseFloat(searchParams.get('minRating') || '0');
    const maxPrice = parseInt(searchParams.get('maxPrice') || '999999');
    const page = parseInt(searchParams.get('page') || '1');
    const limit = parseInt(searchParams.get('limit') || '20');

    const where: any = {
      status: 'APPROVED',
    };

    // Search by name
    if (search) {
      where.user = { name: { contains: search, mode: 'insensitive' } };
    }

    // Filter by specialization
    if (specialization) {
      where.specializations = { has: specialization };
    }

    // Filter by rating
    if (minRating > 0) {
      where.rating = { gte: minRating };
    }

    // Filter by max price (check price60)
    if (maxPrice < 999999) {
      where.price60 = { lte: maxPrice * 100 }; // Convert to cents
    }

    const [psychologists, total] = await Promise.all([
      prisma.psychologist.findMany({
        where,
        include: {
          user: { select: { name: true, image: true } },
          hospital: { select: { name: true, location: true } },
        },
        orderBy: { rating: 'desc' },
        skip: (page - 1) * limit,
        take: limit,
      }),
      prisma.psychologist.count({ where }),
    ]);

    return NextResponse.json({
      psychologists,
      pagination: {
        page,
        limit,
        total,
        totalPages: Math.ceil(total / limit),
      },
    });
  } catch (error) {
    console.error('Error fetching psychologists:', error);
    return NextResponse.json(
      { error: 'Failed to fetch psychologists' },
      { status: 500 }
    );
  }
}
```

Important:
- Only return APPROVED psychologists
- Include user (name, image) and hospital relations
- Support search, specialization, rating, price filters
- Pagination with page/limit
- Prices stored in cents, convert for comparison
- Case-insensitive search
  </action>
  <verify>
```bash
# Test API without filters
curl http://localhost:3000/api/psychologists | jq '.psychologists | length'

# Test with search
curl "http://localhost:3000/api/psychologists?search=sarah" | jq '.psychologists[0].user.name'

# Test with specialization filter
curl "http://localhost:3000/api/psychologists?specialization=Anxiety" | jq '.psychologists | length'

# Test pagination
curl "http://localhost:3000/api/psychologists?page=2&limit=10" | jq '.pagination'
```
  </verify>
  <done>
- /api/psychologists GET endpoint created
- Returns filtered psychologists from database
- Supports search, specialization, rating, price filters
- Includes user and hospital relations
- Pagination works correctly
- Only returns APPROVED psychologists
  </done>
</task>

<task type="auto">
  <name>Task 2: Create individual psychologist API route</name>
  <files>src/app/api/psychologists/[id]/route.ts</files>
  <action>
Create `src/app/api/psychologists/[id]/route.ts` with GET endpoint that fetches a single psychologist by ID.

```typescript
import { NextResponse } from 'next/server';
import { prisma } from '@/lib/prisma';

export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  try {
    const psychologist = await prisma.psychologist.findUnique({
      where: { id: params.id },
      include: {
        user: {
          select: {
            name: true,
            image: true,
            email: true,
          },
        },
        hospital: {
          select: {
            name: true,
            location: true,
            address: true,
          },
        },
        reviews: {
          include: {
            patient: {
              include: {
                user: {
                  select: { name: true, image: true },
                },
              },
            },
          },
          orderBy: { createdAt: 'desc' },
          take: 10,
        },
      },
    });

    if (!psychologist) {
      return NextResponse.json(
        { error: 'Psychologist not found' },
        { status: 404 }
      );
    }

    if (psychologist.status !== 'APPROVED') {
      return NextResponse.json(
        { error: 'Psychologist not available' },
        { status: 403 }
      );
    }

    return NextResponse.json(psychologist);
  } catch (error) {
    console.error('Error fetching psychologist:', error);
    return NextResponse.json(
      { error: 'Failed to fetch psychologist' },
      { status: 500 }
    );
  }
}
```

Important:
- Fetch by psychologist ID (not user ID)
- Include user, hospital, and reviews relations
- Only return APPROVED psychologists (403 if not approved)
- 404 if not found
- Reviews include patient user info (name, image)
- Order reviews by most recent
  </action>
  <verify>
```bash
# Get a psychologist ID from listing
PSYCH_ID=$(curl -s http://localhost:3000/api/psychologists | jq -r '.psychologists[0].id')

# Test individual psychologist fetch
curl "http://localhost:3000/api/psychologists/${PSYCH_ID}" | jq '.user.name, .hospital.name, .reviewCount'

# Test 404 for invalid ID
curl -w "%{http_code}" "http://localhost:3000/api/psychologists/invalid-id"
```
  </verify>
  <done>
- /api/psychologists/[id] GET endpoint created
- Returns single psychologist by ID
- Includes user, hospital, and reviews relations
- Returns 404 for not found
- Returns 403 for non-approved psychologists
- Reviews include patient info
  </done>
</task>

<task type="auto">
  <name>Task 3: Update listing page to use API</name>
  <files>src/app/find-psychologists/page.tsx</files>
  <action>
Update `src/app/find-psychologists/page.tsx` to fetch psychologists from API instead of importing from mock-data.ts.

Replace mock data import:
```typescript
// REMOVE: import { psychologists } from '@/lib/mock-data';

// ADD: Fetch from API
'use client';
import { useEffect, useState } from 'react';

const [psychologists, setPsychologists] = useState([]);
const [loading, setLoading] = useState(true);
const [filters, setFilters] = useState({
  search: '',
  specialization: '',
  minRating: 0,
  maxPrice: 999,
  page: 1,
});

useEffect(() => {
  const fetchPsychologists = async () => {
    setLoading(true);
    const params = new URLSearchParams({
      search: filters.search,
      specialization: filters.specialization,
      minRating: filters.minRating.toString(),
      maxPrice: filters.maxPrice.toString(),
      page: filters.page.toString(),
      limit: '20',
    });

    const res = await fetch(`/api/psychologists?${params}`);
    const data = await res.json();
    setPsychologists(data.psychologists);
    setLoading(false);
  };

  fetchPsychologists();
}, [filters]);
```

Transform data for display:
- API returns user.name → use directly
- API returns price60/price90 in cents → display as "$X" (divide by 100)
- API returns specializations array → use directly
- API returns hospital.location → use directly

Important:
- Keep existing filter UI components
- Add loading state (show skeleton or spinner)
- Handle empty results (no psychologists found message)
- Update filter handlers to modify filters state
- Remove client-side filtering logic (API handles it)
- Keep pagination controls, update to use API pagination
  </action>
  <verify>
```bash
# Start dev server
npm run dev

# Visit listing page
# http://localhost:3000/find-psychologists

# Manual checks:
# 1. Page loads psychologists from database
# 2. Search filter works
# 3. Specialization filter works
# 4. Price filter works
# 5. Rating filter works
# 6. Pagination works
# 7. No console errors
```
  </verify>
  <done>
- find-psychologists/page.tsx updated to fetch from API
- Removed mock-data.ts import
- Added API fetch with filters
- Loading state implemented
- Empty state handled
- Filters trigger API re-fetch
- Pagination connected to API
- Prices displayed correctly (cents → dollars)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] /api/psychologists endpoint returns psychologists with filters
- [ ] /api/psychologists/[id] endpoint returns single psychologist
- [ ] find-psychologists page loads data from API
- [ ] Filters work correctly (search, specialization, rating, price)
- [ ] Pagination works
- [ ] Individual psychologist profiles load from API
- [ ] No imports from mock-data.ts remain
- [ ] npm run build succeeds
</verification>

<success_criteria>

- API routes created and returning database data
- Listing page fetches from API with filters
- Profile pages fetch from API
- No mock data imports in pages
- All filters functional
- Pagination working
- Ready for profile page migration
</success_criteria>

<output>
After completion, create `.planning/phases/03-data-migration/03-02-SUMMARY.md`:

# Phase 3 Plan 2: Psychologist Pages API Migration Summary

**Psychologist listing and profile pages now fetch from PostgreSQL via API routes**

## Accomplishments

- Created /api/psychologists GET endpoint with filtering
- Created /api/psychologists/[id] GET endpoint
- Updated find-psychologists page to use API
- Removed mock-data.ts imports from psychologist pages
- Implemented server-side filtering and pagination

## Files Created/Modified

- `src/app/api/psychologists/route.ts` - List psychologists with filters
- `src/app/api/psychologists/[id]/route.ts` - Get single psychologist
- `src/app/find-psychologists/page.tsx` - Updated to fetch from API
- `src/app/psychologists/[id]/page.tsx` - Updated to fetch from API (if modified)

## API Features

- Search by psychologist name (case-insensitive)
- Filter by specialization (array contains check)
- Filter by minimum rating
- Filter by maximum price
- Pagination (page, limit)
- Only returns APPROVED psychologists
- Includes related user, hospital, and review data

## Decisions Made

- Server-side filtering (better performance than client-side)
- Pagination with 20 items per page default
- Prices remain in cents in database, converted for display
- Reviews limited to 10 most recent on profile page

## Issues Encountered

[Any issues or "None"]

## Next Step

Ready for **03-03-PLAN.md** - Migrate blog, guides, and podcast data to database
</output>
