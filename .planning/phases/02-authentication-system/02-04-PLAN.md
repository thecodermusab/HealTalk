---
phase: 02-authentication-system
plan: 04
type: execute
depends_on:
  - phase: 02-authentication-system
    plan: 03
files_modified: []
---

<objective>
Ensure role-based session data is reliable and middleware protection is consistent across dashboards.

Purpose: Protect patient/psychologist/admin routes and ensure session data includes role + id for client and server usage.

Output: JWT/session callbacks enrich role data, typed session objects, and middleware enforces access consistently.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@src/lib/auth.ts
@src/middleware.ts

**Requirements:**
- Session should include user id + role
- Middleware should block access to wrong dashboard roles
- Keep bootstrap users usable for testing
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enrich JWT/session callbacks + add types</name>
  <files>
src/lib/auth.ts
src/types/next-auth.d.ts (new)
  </files>
  <action>
Ensure JWT callback sets user id + role (and fills missing role from DB if needed).

Expose `session.user.id` and `session.user.role` via TypeScript module augmentation.
  </action>
  <verify>
- Session includes id + role
- TypeScript recognizes extended session fields
  </verify>
  <done>
- Role-aware session data available app-wide
  </done>
</task>

<task type="auto">
  <name>Task 2: Confirm middleware protection + bootstrap usability</name>
  <files>
src/middleware.ts
prisma/seed.ts
  </files>
  <action>
Ensure middleware correctly enforces role-based access.

Mark bootstrap users as verified in seed data (so test accounts can log in under verification rules).
  </action>
  <verify>
- Dashboards blocked for wrong roles
- Bootstrap accounts remain usable for dev testing
  </verify>
  <done>
- Middleware protection stable with verified bootstrap accounts
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Role-aware sessions + middleware protection</what-built>
  <how-to-verify>
1. Login as each bootstrap role and confirm dashboard access.
2. Attempt cross-role access (patient -> admin) and confirm redirect to login.
3. Check session object includes user role and id.
  </how-to-verify>
  <resume-signal>Type "approved 02-04" once role protection works as expected</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Session includes user id + role
- [ ] Middleware blocks incorrect roles
- [ ] Bootstrap accounts verified for dev login
</verification>

<success_criteria>
- Role-aware session data available across the app
- Middleware protection correctly gates dashboards
- Bootstrap accounts remain usable
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-04-SUMMARY.md`
</output>
