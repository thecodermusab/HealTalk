---
phase: 02-authentication-system
plan: 02
type: execute
depends_on:
  - phase: 02-authentication-system
    plan: 01
files_modified: []
---

<objective>
Implement email verification for credential-based registrations.

Purpose: Prevent unverified accounts from accessing dashboards, and provide a secure verification email flow.

Output: Registration sends verification email, verification endpoint activates user, and login enforces verification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@src/app/api/auth/register/route.ts
@src/lib/auth.ts
@prisma/schema.prisma

**Requirements:**
- Use Resend (free tier) for sending verification email
- Store verification tokens with expiry
- Block credentials sign-in until verified
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add verification token generation + email sending</name>
  <files>
src/app/api/auth/register/route.ts
src/lib/email.ts (new)
src/lib/tokens.ts (new)
  </files>
  <action>
Create a token helper for secure random tokens and hashing.

Add a lightweight email helper using Resend; fall back to console logging when API key is missing.

On registration:
- Create the user (emailVerified remains null)
- Generate verification token with 24h expiry
- Store token in `VerificationToken`
- Send verification email with a link to `/verify-email?token=...`
  </action>
  <verify>
- New users receive verification email (or console log)
- Verification tokens stored with expiry
  </verify>
  <done>
- Registration triggers verification email flow
  </done>
</task>

<task type="auto">
  <name>Task 2: Build verification endpoint + UI</name>
  <files>
src/app/api/auth/verify-email/route.ts (new)
src/app/(auth)/verify-email/page.tsx (new)
  </files>
  <action>
Implement a verification API route that:
- Validates token
- Ensures token is for email verification
- Marks user emailVerified
- Deletes the token

Add a simple verify-email page that calls the API and shows success/error state with a login CTA.
  </action>
  <verify>
- Visiting verify link sets emailVerified
- Token is invalid after use
- UI shows clear success/error messaging
  </verify>
  <done>
- Email verification completes end-to-end
  </done>
</task>

<task type="auto">
  <name>Task 3: Enforce verification on credentials sign-in</name>
  <files>src/lib/auth.ts</files>
  <action>
Block credentials sign-in when emailVerified is null, while allowing OAuth users to sign in.
  </action>
  <verify>
- Unverified credential accounts cannot log in
- Verified users can sign in normally
  </verify>
  <done>
- Email verification enforced for credentials flow
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Email verification flow for credentials sign-up</what-built>
  <how-to-verify>
1. Register a new account.
2. Confirm verification email (or console log) includes link.
3. Click link and verify success message.
4. Attempt login before verification (should be blocked).
5. Login after verification (should succeed).
  </how-to-verify>
  <resume-signal>Type "approved 02-02" once verification is working</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Registration sends verification email
- [ ] Verification endpoint activates user
- [ ] Login blocks unverified users
</verification>

<success_criteria>
- Email verification token flow implemented
- Verified users can sign in; unverified users cannot
- Verification UI provides clear feedback
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-02-SUMMARY.md`
</output>
