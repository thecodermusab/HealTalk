---
phase: 09-admin-panel
plan: 04
type: execute
depends_on:
  - phase: 09-admin-panel
    plan: 03
files_modified: []
---

<objective>
Add admin user management for banning, deleting, and editing profiles.

Purpose: Give admins control over user accounts to handle abuse or support requests.

Output: User status fields, admin API routes, and a management UI.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma
@src/lib/auth.ts
@src/middleware.ts
@src/components/dashboard/DashboardLayout.tsx

**Current state:**
- No user status or ban flags in DB
- No admin UI for users/patients
- Middleware only checks role

**Requirements:**
- Admin can list and search users
- Admin can ban/suspend/reactivate users
- Admin can edit basic profile fields
- Admin can delete users (cascade)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user status fields</name>
  <files>prisma/schema.prisma</files>
  <action>
Add a user status field to support banning and suspensions.

Suggested:
- `UserStatus` enum (ACTIVE, SUSPENDED, BANNED)
- Add `status` to User with default ACTIVE
- Optional: `bannedAt` and `suspendedAt`

Run Prisma migration after updates.
  </action>
  <verify>
- Migration applies cleanly
- Prisma client updated
  </verify>
  <done>
- User status fields available
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce status in auth + middleware</name>
  <files>src/lib/auth.ts, src/middleware.ts</files>
  <action>
Update NextAuth callbacks to include user status in JWT/session, and block access for BANNED users (optionally SUSPENDED) in middleware.

Show a friendly error or redirect to a blocked page if needed.
  </action>
  <verify>
- Banned users cannot access dashboard routes
- Session contains status
  </verify>
  <done>
- User status enforcement in place
  </done>
</task>

<task type="auto">
  <name>Task 3: Build admin user management API + UI</name>
  <files>
src/app/api/admin/users/route.ts (new)
src/app/api/admin/users/[id]/route.ts (new)
src/app/(dashboard)/admin/dashboard/patients/page.tsx (new)
src/components/dashboard/DashboardLayout.tsx
  </files>
  <action>
Create admin-only endpoints:
- `GET /api/admin/users` with filters (role, status, search)
- `PATCH /api/admin/users/[id]` for status changes and profile edits
- `DELETE /api/admin/users/[id]` for account removal

Build an admin UI page to manage users (patients by default, with filters for roles).
Add navigation entry or reuse existing "Patients" link.
  </action>
  <verify>
- Admin can list, edit, ban, and delete users
- UI reflects status changes immediately
  </verify>
  <done>
- User management UI operational
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] User status fields exist and migrated
- [ ] Auth/middleware blocks banned users
- [ ] Admin API routes for users work
- [ ] Admin user management UI works
</verification>

<success_criteria>
- Admins can manage users and enforce bans/suspensions
</success_criteria>

<output>
After completion, create `.planning/phases/09-admin-panel/09-04-SUMMARY.md`
</output>
