---
phase: 07-realtime-messaging
plan: 02
type: execute
depends_on:
  - phase: 07-realtime-messaging
    plan: 01
files_modified: []
---

<objective>
Build messaging UI and real-time message delivery.

Purpose: Enable patients and psychologists to chat in real time with persistence.

Output: Messages page with conversation list + message thread, backed by DB + socket.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@prisma/schema.prisma

**Requirements:**
- Save messages in DB
- Real-time updates via socket
- Use appointment context for room
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add message API routes</name>
  <files>
src/app/api/messages/[appointmentId]/route.ts (new)
src/app/api/messages/[appointmentId]/send/route.ts (optional)
  </files>
  <action>
Create endpoints to fetch message history and persist new messages.
  </action>
  <verify>
Messages can be fetched and stored via API.
  </verify>
  <done>
- Message API routes ready
  </done>
</task>

<task type="auto">
  <name>Task 2: Build messages page UI</name>
  <files>
src/app/(dashboard)/patient/dashboard/messages/page.tsx
src/app/(dashboard)/psychologist/dashboard/messages/page.tsx
src/components/messages/MessageThread.tsx (new)
  </files>
  <action>
Implement a shared message UI that:
- Loads appointment context from query param
- Loads message history
- Subscribes to socket room for real-time updates
- Sends messages via socket/API
  </action>
  <verify>
Messages send/receive in real time.
  </verify>
  <done>
- Messaging UI functional
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Messages API routes working
- [ ] UI receives and sends messages via socket
</verification>

<success_criteria>
- Real-time messaging works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/07-realtime-messaging/07-02-SUMMARY.md`
</output>
